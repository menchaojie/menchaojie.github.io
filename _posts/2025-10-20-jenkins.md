---
layout: post
title: Jenkins ä½¿ç”¨ä¸­è¦æ³¨æ„çš„å°é—®é¢˜
categories:
  - jenkins
description: å­¦ä¸€äº›jenkinsçŸ¥è¯†
keywords:  
  - jenkins
  - k8s
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---



#  Jenkins + Docker + Harbor + Kubernetes CI/CD å®è·µè®°å½•

> ä¸€æ­¥æ­¥æ„å»ºå¯å¤ç°ã€å¯è‡ªåŠ¨åŒ–çš„æŒç»­é›†æˆä¸æŒç»­éƒ¨ç½²æµæ°´çº¿ã€‚

---

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

åœ¨ç°ä»£å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæŒç»­é›†æˆï¼ˆCIï¼‰ä¸æŒç»­éƒ¨ç½²ï¼ˆCDï¼‰æ˜¯å¿…ä¸å¯å°‘çš„åŸºç¡€è®¾æ–½ã€‚æœ¬æ¬¡è®°å½•å†…å®¹ä¸ºï¼š

> **é€šè¿‡ Jenkins å®ç°è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€æ‰“åŒ…ã€æ¨é€é•œåƒåˆ° Harborï¼Œå¹¶è‡ªåŠ¨éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚**

æœ€ç»ˆå®ç°æ•ˆæœï¼š

* Jenkins è‡ªåŠ¨æ‹‰å– GitLab ä»£ç 
* è‡ªåŠ¨è¿è¡Œæµ‹è¯•
* æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° Harbor
* è‡ªåŠ¨éƒ¨ç½²æ›´æ–°åˆ° K8s é›†ç¾¤
* Flask åº”ç”¨è‡ªåŠ¨å¯åŠ¨å¹¶å¯è®¿é—®

---

## äºŒã€ç³»ç»Ÿç¯å¢ƒæ¦‚è§ˆ

| ç»„ä»¶         | ç‰ˆæœ¬           | è¯´æ˜                           |
| ---------- | ------------ | ---------------------------- |
| OS         | Ubuntu 22.04 | æ‰€æœ‰èŠ‚ç‚¹ä¸€è‡´                       |
| Kubernetes | v1.29        | ä¸‰èŠ‚ç‚¹é›†ç¾¤ï¼ˆ1 Master + 2 Nodeï¼‰     |
| Docker     | 24.0.7       | å·²å¯ç”¨ `/var/run/docker.sock`   |
| Jenkins    | 2.462.1      | ä»¥ `jenkins-admin` ServiceAccount éƒ¨ç½²åœ¨ K8s |
| Harbor     | 2.9          | ç§æœ‰é•œåƒä»“åº“                       |
| GitLab     | 16.x         | æºä»£ç æ‰˜ç®¡                        |
| Python     | 3.11         | Flask åº”ç”¨è¿è¡Œç¯å¢ƒ                 |

---

## ä¸‰ã€æµæ°´çº¿æ€»ä½“ç»“æ„

æ•´ä¸ªæµç¨‹æŒ‰é˜¶æ®µåˆ’åˆ†å¦‚ä¸‹ï¼š

```
Start
  â†“
Checkout
  â†“
Test
  â†“
Build Docker
  â†“
Push Docker (Harbor)
  â†“
Deploy to K8s
  â†“
End
```

æ¯ä¸ªé˜¶æ®µéƒ½è¿è¡Œåœ¨ Jenkins çš„ Kubernetes åŠ¨æ€ Agent Pod ä¸­ï¼Œé€šè¿‡ä¸åŒå®¹å™¨å®Œæˆå¯¹åº”ä»»åŠ¡ã€‚

---

## å››ã€Kubernetes åŠ Jenkins åŸºç¡€é…ç½®

### 1. Jenkins ä½¿ç”¨çš„ ServiceAccount ä¸æƒé™

åˆ›å»º Jenkins çš„é›†ç¾¤è§’è‰²ä¸ç»‘å®šï¼š

```yaml
# jenkins-01-serviceAccount.yml
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: jenkins-admin
rules:
  - apiGroups: [""]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "daemonsets"]
    verbs: ["*"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins-admin
  namespace: devops-tools
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jenkins-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jenkins-admin
subjects:
- kind: ServiceAccount
  name: jenkins-admin
  namespace: devops-tools
```

**éªŒè¯æƒé™æ˜¯å¦ç”Ÿæ•ˆï¼š**

```bash
# first configured
kubectl apply -f jenkins-01-serviceAccount.yml
# and then ...
kubectl describe clusterrole jenkins-admin
```

è¾“å‡ºä¸­åº”åŒ…å«ï¼š

```
Resources: *   Verbs: *
```

---

### 2. åˆ›å»ºåº”ç”¨å‘½åç©ºé—´

```bash
kubectl create namespace dev
kubectl get ns
```

ç¡®è®¤è¾“å‡ºä¸­æœ‰ï¼š

```
dev   Active
```

---

## äº”ã€è‡ªå®šä¹‰ kubectl-agent é•œåƒ

ä¸ºäº†åœ¨ Jenkins Agent ä¸­æ‰§è¡Œ `kubectl` å‘½ä»¤ï¼Œæˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªè½»é‡çº§å·¥å…·é•œåƒï¼š

```dockerfile
# Dockerfile
FROM alpine:3.18
RUN apk add --no-cache bash curl wget ca-certificates
RUN wget https://dl.k8s.io/release/v1.34.1/bin/linux/amd64/kubectl -O /usr/local/bin/kubectl && \
    chmod +x /usr/local/bin/kubectl
WORKDIR /home/jenkins
CMD ["/bin/bash"]
```

æ„å»ºä¸æ¨é€ï¼š

```bash
docker build -t kubernetes-registry.moon.com/moon/kubectl-agent:1.0 .
docker push kubernetes-registry.moon.com/moon/kubectl-agent:1.0
```

éªŒè¯ï¼š

```bash
docker run --rm -it kubernetes-registry.moon.com/moon/kubectl-agent:1.0 bash
kubectl version --client
```

---

## å…­ã€å®Œæ•´ Jenkinsfile

```groovy
pipeline {
    agent {
        kubernetes {
            cloud 'k8s-cloud'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-admin
  containers:
  - name: jnlp
    image: kubernetes-registry.moon.com/moon/inbound-agent:3345.v03dee9b_f88fc
    args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
  - name: docker
    image: kubernetes-registry.moon.com/moon/docker:24.0.7-cli
    command: ['cat']
    tty: true
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
  - name: python
    image: kubernetes-registry.moon.com/moon/python:3.11-slim
    command: ['cat']
    tty: true
  - name: kubectl-agent
    image: kubernetes-registry.moon.com/moon/kubectl-agent:1.0
    command: ['cat']
    tty: true
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
      type: Socket
  dnsPolicy: ClusterFirst
  restartPolicy: Never
'''
        }
    }

    environment {
        REGISTRY = "kubernetes-registry.moon.com/moon"
        IMAGE = "my-flask-app"
        TAG = "v${env.BUILD_NUMBER}"
        HARBOR_CREDS = credentials('harbor-credentials')
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Test') {
            steps {
                container('python') {
                    sh '''
                    echo "Running pytest..."
                    pip install -r requirements.txt -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
                    pytest tests/
                    '''
                }
            }
        }

        stage('Build Docker') {
            steps {
                container('docker') {
                    sh '''
                    echo "Building image..."
                    docker build -t ${REGISTRY}/${IMAGE}:${TAG} .
                    '''
                }
            }
        }

        stage('Push Docker') {
            steps {
                container('docker') {
                    sh '''
                    echo "Pushing image to Harbor..."
                    echo "$HARBOR_CREDS_PSW" | docker login ${REGISTRY} -u "$HARBOR_CREDS_USR" --password-stdin
                    docker push ${REGISTRY}/${IMAGE}:${TAG}
                    '''
                }
            }
        }

        stage('Deploy to K8s') {
            steps {
                container('kubectl-agent') {
                    sh '''
                    echo "Deploying new image..."
                    kubectl set image deployment/my-flask-app my-flask-app=${REGISTRY}/${IMAGE}:${TAG} -n dev || \
                    kubectl create deployment my-flask-app --image=${REGISTRY}/${IMAGE}:${TAG} -n dev
                    '''
                }
            }
        }
    }

    post {
        success { echo "ğŸ‰ Deployment successful! ${REGISTRY}/${IMAGE}:${TAG}" }
        failure { echo "âŒ Pipeline failed. Check the logs for details." }
    }
}
```

---

## ä¸ƒã€éƒ¨ç½²éªŒè¯

æŸ¥çœ‹ Deployment å’Œ Podï¼š

```bash
kubectl get deployments -n dev
kubectl get pods -n dev -o wide
```

ç¡®è®¤ Pod çŠ¶æ€ä¸ºï¼š

```
my-flask-app   1/1     Running
```

æµ‹è¯•åº”ç”¨ï¼š

```bash
curl <Pod_IP>:5000
```

è¾“å‡ºç¤ºä¾‹ï¼š

```json
{"env":"dev","message":"Hello from Flask"}
```

éªŒè¯æˆåŠŸ 

---

## å…«ã€å¸¸è§é—®é¢˜ä¸æ’é”™æ€»ç»“

| é—®é¢˜                                    | åŸå›                           | è§£å†³æ–¹å¼                                  |
| ------------------------------------- | --------------------------- | ------------------------------------- |
| `Cannot connect to the Docker daemon` | Jenkins Pod å†…æ— æ³•è®¿é—®å®¿ä¸»æœº Docker | åœ¨ Pod YAML ä¸­æŒ‚è½½ `/var/run/docker.sock` |
| `kubectl: not found`                  | é•œåƒæ—  kubectl å‘½ä»¤              | ä½¿ç”¨è‡ªåˆ¶ `kubectl-agent`                  |
| `CrashLoopBackOff`                    | åŸºç¡€é•œåƒæ—  bash                  | æ”¹ä¸º `alpine:3.18 + bash`               |
| `User ... cannot create deployments`  | RBAC æƒé™ä¸è¶³                   | åˆ›å»º `jenkins-admin` ClusterRoleBinding |
| `namespaces "dev" not found`          | æœªåˆ›å»ºå‘½åç©ºé—´                     | `kubectl create namespace dev`        |
| `Address already in use`              | Pod å·²å¯åŠ¨ Flask æœåŠ¡            | è¯´æ˜å®¹å™¨æ­£å¸¸è¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨å¯åŠ¨                       |

---

## ä¹ã€ç»éªŒæ€»ç»“

* **Pipeline åˆ†å±‚æ¸…æ™°**ï¼Œæ¯ä¸ªå®¹å™¨è´Ÿè´£å•ä¸€ä»»åŠ¡ï¼ˆæµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²ï¼‰ã€‚
* **æƒé™ä¼˜å…ˆæ£€æŸ¥**ï¼ŒRBAC æ˜¯éƒ¨ç½²é˜¶æ®µå¤±è´¥çš„é«˜é¢‘åŸå› ã€‚
* **è‡ªå®šä¹‰å·¥å…·é•œåƒ** èƒ½æå¤§æå‡å¯å¤ç”¨æ€§ã€‚
* **æ¯ä¸€æ­¥éƒ½è¦éªŒè¯**ï¼Œç‰¹åˆ«æ˜¯ RBACã€docker.sockã€å‘½åç©ºé—´æ˜¯å¦æ­£ç¡®ã€‚
* **æœ€ç»ˆé—­ç¯éªŒè¯**ï¼šèƒ½ä» Jenkins ä¸€é”®è§¦å‘ï¼Œåˆ° K8s Pod æˆåŠŸå“åº” HTTP è¯·æ±‚ã€‚

