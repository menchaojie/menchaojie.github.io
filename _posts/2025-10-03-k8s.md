---
layout: post
title: Kubernetes
categories:
  - k8s
description: å­¦ä¸€äº›k8sçŸ¥è¯†
keywords:  
  - linux
  - k8s
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---



# Kubernetes é›†ç¾¤æ­å»ºç¬”è®°ï¼ˆUbuntu 24.04 + kubeadm + Docker + cri-dockerd + Flannelï¼‰

æœ¬æ–‡è®°å½•äº†åœ¨ windows è™šæ‹ŸæœºVMwareä¸­å®‰è£… **Ubuntu 24.04** ï¼Œä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤çš„è¿‡ç¨‹ï¼Œç‰ˆæœ¬ä¸º **v1.28.15**ï¼Œä½¿ç”¨ **Docker** ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ **cri-dockerd** é€‚é…ï¼Œç½‘ç»œæ’ä»¶é€‰ç”¨ **Flannel**ã€‚  

---

## 1. ä¸»æœºè§„åˆ’

- `kubernetes-master`ï¼šæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼ˆmasterï¼‰  
- `kubernetes-node1`ã€`kubernetes-node2`ï¼šå·¥ä½œèŠ‚ç‚¹ï¼ˆnodeï¼‰  
- `kubernetes-registry`ï¼šç§æœ‰é•œåƒä»“åº“  

---

## 2. å®‰è£… Docker

ä½¿ç”¨é˜¿é‡Œäº‘æºå®‰è£… Docker CEï¼š  
[é˜¿é‡Œäº‘ Docker å®‰è£…æ–‡æ¡£](https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.57e31b11dCQH1l)

éªŒè¯å®‰è£…ï¼š  

```bash
docker version
systemctl enable docker --now
```
ä¸ºäº†æ–¹ä¾¿æ™®é€šç”¨æˆ·ä½¿ç”¨ï¼Œå¯ä»¥å°†å½“å‰ç”¨æˆ·åŠ å…¥dockerç»„ä¸­
```bash
sudo usermod -aG docker $USER
newgrp docker
```

---

## 3. å®‰è£… cri-dockerd

Kubernetes ä» 1.24 èµ·ä¸å†ç›´æ¥æ”¯æŒ Dockerï¼Œéœ€è¦ `cri-dockerd` ä½œä¸ºé€‚é…å±‚ã€‚

å‚è€ƒæ–‡æ¡£ï¼š[å®˜æ–¹æ–‡æ¡£](https://mirantis.github.io/cri-dockerd/usage/install/)
[cri-dockerd å®‰è£…](https://www.cnblogs.com/wangguishe/p/17825991.html)

å®‰è£…å®Œæˆåï¼Œç¡®è®¤ socket æ–‡ä»¶è·¯å¾„ï¼š

* Dockerï¼š`/var/run/cri-dockerd.sock`
* containerdï¼š`/var/run/containerd/containerd.sock`

---

## 4. å®‰è£… Kubernetes ç»„ä»¶

éœ€è¦å®‰è£…ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š

* `kubelet`ï¼šèŠ‚ç‚¹ä»£ç†ï¼Œè´Ÿè´£å¯åŠ¨å’Œç®¡ç† Pod
* `kubeadm`ï¼šé›†ç¾¤åˆå§‹åŒ–å·¥å…·
* `kubectl`ï¼šå‘½ä»¤è¡Œå®¢æˆ·ç«¯

å‚è€ƒé˜¿é‡Œäº‘é•œåƒæºï¼š
[é˜¿é‡Œäº‘ Kubernetes é•œåƒ](https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.73281b11Uyt6jP)

---

## 5. åˆå§‹åŒ–å‰ç¯å¢ƒæ¸…ç†è„šæœ¬

æ–‡ä»¶ï¼š`prepare_env.sh`

```bash
#!/bin/bash
set -e

echo "[1/5] åœæ­¢ kubelet..."
sudo systemctl stop kubelet

# æ£€æµ‹ CRI
if [ -S /var/run/cri-dockerd.sock ]; then
    CRI_SOCKET="unix:///var/run/cri-dockerd.sock"
    echo "[+] Docker CRI detected, using $CRI_SOCKET"
elif [ -S /var/run/containerd/containerd.sock ]; then
    CRI_SOCKET="unix:///var/run/containerd/containerd.sock"
    echo "[+] containerd detected, using $CRI_SOCKET"
else
    echo "[-] No CRI detected! Exiting."
    exit 1
fi

echo "[2/5] é‡ç½® kubeadm..."
sudo kubeadm reset -f --cri-socket=$CRI_SOCKET --ignore-preflight-errors=Swap

echo "[3/5] æ¸…ç†æ—§è¯ä¹¦å’Œé…ç½®..."
sudo rm -rf /etc/kubernetes/pki
sudo rm -rf /etc/kubernetes/*.conf
sudo rm -rf ~/.kube

echo "[4/5] åˆ é™¤æ—§çš„ etcd æ•°æ®å’Œ kubelet çŠ¶æ€..."
sudo rm -rf /var/lib/etcd
sudo rm -rf /var/lib/kubelet/*

echo "[5/5] æ£€æŸ¥ç«¯å£ 6443 å ç”¨..."
if lsof -i :6443 >/dev/null; then
    echo "[-] Port 6443 is still in use! Please kill the process occupying it before proceeding."
    lsof -i :6443
    exit 1
fi

echo "ç¯å¢ƒæ¸…ç†å®Œæˆï¼ŒCRI socket: $CRI_SOCKET"
```

æ‰§è¡Œè„šæœ¬ï¼š

```bash
bash prepare_env.sh
```

---

## 6. åˆå§‹åŒ– Master èŠ‚ç‚¹

ä¸ºé¿å…é•œåƒæ‹‰å–æ˜¯å‡ºç°é—®é¢˜ï¼Œä½¿ç”¨kubeadmåˆå§‹åŒ–ä¹‹å‰å…ˆè¦å‡†å¤‡å¥½dockeré•œåƒï¼Œæœ¬æ¬¡è®°å½•ä¸­é€šè¿‡
```bash
kubeadm config images list
```
è·å–é•œåƒåˆ—è¡¨ï¼Œç„¶åä»é˜¿é‡Œäº‘è·å–é•œåƒå­˜å…¥æœ¬åœ°harborçš„æ–¹æ³•ï¼Œè§å¦‚ä¸‹çš„å‘½ä»¤

```bash
#!/bin/bash
#
# åŒæ­¥ Kubernetes æ ¸å¿ƒé•œåƒåˆ°ç§æœ‰ Harbor ä»“åº“
# ç‰ˆæœ¬ï¼š1.28.15
# è¯´æ˜ï¼š
#   1. ä»é˜¿é‡Œäº‘ registry æ‹‰å–é•œåƒï¼ˆè§£å†³å›½å¤– registry æ‹‰å–æ…¢çš„é—®é¢˜ï¼‰
#   2. é‡æ–°æ‰“ tag åˆ°å†…éƒ¨ Harbor
#   3. æ¨é€åˆ°å†…ç½‘ Harbor
#   4. åˆ é™¤ä¸­è½¬é•œåƒï¼Œé¿å…æ··ä¹±
#

#-----------------------------
# åŸºæœ¬å˜é‡é…ç½®
#-----------------------------
K8S_VERSION="1.28.15"                                     # æŒ‡å®š Kubernetes ç‰ˆæœ¬
SRC_REGISTRY="registry.aliyuncs.com/google_containers"    # æºé•œåƒä»“åº“ï¼ˆé˜¿é‡Œäº‘é•œåƒï¼‰
DST_REGISTRY="kubernetes-registry.moon.com/google_containers"  # ç›®æ ‡ç§æœ‰ä»“åº“ï¼ˆHarborï¼‰

#-----------------------------
# Step 1: è·å–è¯¥ç‰ˆæœ¬æ‰€éœ€é•œåƒåˆ—è¡¨
#-----------------------------
# kubeadm ä¼šåˆ—å‡ºéƒ¨ç½²è¯¥ç‰ˆæœ¬ Kubernetes æ‰€éœ€çš„æ‰€æœ‰é•œåƒ
# ä¾‹å¦‚ï¼šregistry.k8s.io/kube-apiserver:v1.28.15
# awk æå–æœ€åä¸€æ®µï¼Œåªä¿ç•™ "kube-apiserver:v1.28.15"
#-----------------------------
echo "[INFO] è·å– Kubernetes $K8S_VERSION é•œåƒåˆ—è¡¨..."
images=$(kubeadm config images list --kubernetes-version="${K8S_VERSION}" | awk -F'/' '{print $NF}')

#-----------------------------
# Step 2: å¾ªç¯åŒæ­¥æ¯ä¸ªé•œåƒ
#-----------------------------
for image in ${images}; do
    echo
    echo "==============================="
    echo "[INFO] æ­£åœ¨å¤„ç†é•œåƒ: ${image}"
    echo "==============================="

    # æ‹‰å–é•œåƒï¼ˆä»é˜¿é‡Œäº‘æºï¼‰
    echo "[STEP] æ‹‰å– ${SRC_REGISTRY}/${image}"
    docker pull ${SRC_REGISTRY}/${image}

    # æ‰“ä¸Šç§æœ‰ä»“åº“æ ‡ç­¾
    echo "[STEP] é‡æ–°æ‰“æ ‡ç­¾ä¸º ${DST_REGISTRY}/${image}"
    docker tag ${SRC_REGISTRY}/${image} ${DST_REGISTRY}/${image}

    # æ¨é€åˆ°ç§æœ‰ Harbor ä»“åº“
    echo "[STEP] æ¨é€åˆ° Harborï¼š${DST_REGISTRY}/${image}"
    docker push ${DST_REGISTRY}/${image}

    # åˆ é™¤ä¸­è½¬é•œåƒï¼Œåªä¿ç•™ç›®æ ‡é•œåƒ
    echo "[STEP] åˆ é™¤æœ¬åœ°ä¸­è½¬é•œåƒ ${SRC_REGISTRY}/${image}"
    docker rmi ${SRC_REGISTRY}/${image}

    echo "[DONE] é•œåƒ ${image} å·²åŒæ­¥è‡³ Harborã€‚"
done

#-----------------------------
# Step 3: å®Œæˆæç¤º
#-----------------------------
echo
echo "=========================================="
echo "[SUCCESS] æ‰€æœ‰ Kubernetes ${K8S_VERSION} é•œåƒå·²åŒæ­¥å®Œæˆã€‚"
echo "å¯åœ¨ Harbor ä¸ŠæŸ¥çœ‹ï¼š${DST_REGISTRY}"
echo "=========================================="

```
ä¹‹åå°±å¯ä»¥åˆå§‹åŒ–äº†ï¼Œè§å¦‚ä¸‹bashæ–‡ä»¶

æ–‡ä»¶ï¼š`init_k8s.sh`

```bash
#!/bin/bash
set -e

# è¯·æ ¹æ® prepare_env.sh è¾“å‡ºå¡«å…¥ CRI socket
CRI_SOCKET="unix:///var/run/cri-dockerd.sock"

echo "[1/1] åˆå§‹åŒ– Kubernetes master..."
sudo kubeadm init \
  --kubernetes-version=1.28.15 \
  --apiserver-advertise-address=10.0.0.5 \
  --image-repository=kubernetes-registry.moon.com/google_containers \
  --pod-network-cidr="10.244.0.0/16" \
  --service-cidr="10.96.0.0/12" \
  --ignore-preflight-errors=Swap \
  --cri-socket=$CRI_SOCKET

echo "------------------------------------------------"
echo "åˆå§‹åŒ–å®Œæˆï¼"
```

æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬ï¼š

```bash
bash init_k8s.sh
```

åˆå§‹åŒ–æˆåŠŸåï¼Œæ ¹æ® `kubeadm init` çš„è¾“å‡ºï¼Œå¤åˆ¶ `kubeadm join` å‘½ä»¤åˆ°å„ä¸ª `node` èŠ‚ç‚¹è¿è¡Œã€‚

---

## 7. é…ç½® kubectl

åœ¨ master èŠ‚ç‚¹æ‰§è¡Œï¼š

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

éªŒè¯ï¼š

```bash
kubectl get nodes
```

---

## 8. å®‰è£…ç½‘ç»œæ’ä»¶ Flannel

å®‰è£… Flannel ç½‘ç»œæ’ä»¶ï¼Œä¿è¯ Pod ä¹‹é—´å¯ä»¥äº’é€šï¼š

```bash
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
```

---

## 9. éªŒè¯é›†ç¾¤çŠ¶æ€

```bash
kubectl get nodes
```

ç¤ºä¾‹è¾“å‡ºï¼š

```bash
NAME                STATUS   ROLES           AGE   VERSION
kubernetes-master   Ready    control-plane   47h   v1.28.15
kubernetes-node1    Ready    <none>          26h   v1.28.15
kubernetes-node2    Ready    <none>          26h   v1.28.15
```

è‡³æ­¤ï¼ŒKubernetes é›†ç¾¤å®‰è£…å®Œæˆ ğŸ‰

---

## 10. å¸¸è§é—®é¢˜æ’æŸ¥

1. **swap æœªå…³é—­**

   * Kubernetes è¦æ±‚ç¦ç”¨ swapï¼š

     ```bash
     sudo swapoff -a
     sed -i '/ swap / s/^/#/' /etc/fstab
     ```

2. **é•œåƒæ‹‰å–å¤±è´¥**

   * é…ç½®å›½å†…é•œåƒä»“åº“ï¼ˆå¦‚é˜¿é‡Œäº‘ã€ä¸ƒç‰›ã€è…¾è®¯äº‘ï¼‰ï¼Œæˆ–ä½¿ç”¨è‡ªå»º `kubernetes-registry`ã€‚

3. **6443 ç«¯å£è¢«å ç”¨**

   * æ£€æŸ¥å¹¶é‡Šæ”¾ç«¯å£ï¼š

     ```bash
     lsof -i :6443
     kill -9 <PID>
     ```

4. **flannel ç½‘ç»œä¸é€š**

   * ç¡®è®¤ `--pod-network-cidr` ä¸ flannel é…ç½®ä¸€è‡´ï¼ˆé»˜è®¤ `10.244.0.0/16`ï¼‰ã€‚
   * æ£€æŸ¥ CNI æ’ä»¶ç›®å½• `/etc/cni/net.d/` æ˜¯å¦å­˜åœ¨é…ç½®æ–‡ä»¶ã€‚

