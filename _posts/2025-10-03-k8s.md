---
layout: post
title: Kubernetes
categories:
  - k8s
description: å­¦ä¸€äº›k8sçŸ¥è¯†
keywords:  
  - linux
  - k8s
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---



# Kubernetes é›†ç¾¤æ­å»ºç¬”è®°ï¼ˆUbuntu 24.04 + kubeadm + Docker + cri-dockerd + Flannelï¼‰

æœ¬æ–‡è®°å½•äº†åœ¨ windows è™šæ‹ŸæœºVMwareä¸­å®‰è£… **Ubuntu 24.04** ï¼Œä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤çš„è¿‡ç¨‹ï¼Œç‰ˆæœ¬ä¸º **v1.28.15**ï¼Œä½¿ç”¨ **Docker** ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ **cri-dockerd** é€‚é…ï¼Œç½‘ç»œæ’ä»¶é€‰ç”¨ **Flannel**ã€‚  

---

## 1. ä¸»æœºè§„åˆ’

- `kubernetes-master`ï¼šæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼ˆmasterï¼‰  
- `kubernetes-node1`ã€`kubernetes-node2`ï¼šå·¥ä½œèŠ‚ç‚¹ï¼ˆnodeï¼‰  
- `kubernetes-registry`ï¼šç§æœ‰é•œåƒä»“åº“  

---

## 2. å®‰è£… Docker

ä½¿ç”¨é˜¿é‡Œäº‘æºå®‰è£… Docker CEï¼š  
[é˜¿é‡Œäº‘ Docker å®‰è£…æ–‡æ¡£](https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.57e31b11dCQH1l)

éªŒè¯å®‰è£…ï¼š  

```bash
docker version
systemctl enable docker --now
```

---

## 3. å®‰è£… cri-dockerd

Kubernetes ä» 1.24 èµ·ä¸å†ç›´æ¥æ”¯æŒ Dockerï¼Œéœ€è¦ `cri-dockerd` ä½œä¸ºé€‚é…å±‚ã€‚

å‚è€ƒæ–‡æ¡£ï¼š[cri-dockerd å®‰è£…](https://www.cnblogs.com/wangguishe/p/17825991.html)

å®‰è£…å®Œæˆåï¼Œç¡®è®¤ socket æ–‡ä»¶è·¯å¾„ï¼š

* Dockerï¼š`/var/run/cri-dockerd.sock`
* containerdï¼š`/var/run/containerd/containerd.sock`

---

## 4. å®‰è£… Kubernetes ç»„ä»¶

éœ€è¦å®‰è£…ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š

* `kubelet`ï¼šèŠ‚ç‚¹ä»£ç†ï¼Œè´Ÿè´£å¯åŠ¨å’Œç®¡ç† Pod
* `kubeadm`ï¼šé›†ç¾¤åˆå§‹åŒ–å·¥å…·
* `kubectl`ï¼šå‘½ä»¤è¡Œå®¢æˆ·ç«¯

å‚è€ƒé˜¿é‡Œäº‘é•œåƒæºï¼š
[é˜¿é‡Œäº‘ Kubernetes é•œåƒ](https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.73281b11Uyt6jP)

---

## 5. åˆå§‹åŒ–å‰ç¯å¢ƒæ¸…ç†è„šæœ¬

æ–‡ä»¶ï¼š`prepare_env.sh`

```bash
#!/bin/bash
set -e

echo "[1/5] åœæ­¢ kubelet..."
sudo systemctl stop kubelet

# æ£€æµ‹ CRI
if [ -S /var/run/cri-dockerd.sock ]; then
    CRI_SOCKET="unix:///var/run/cri-dockerd.sock"
    echo "[+] Docker CRI detected, using $CRI_SOCKET"
elif [ -S /var/run/containerd/containerd.sock ]; then
    CRI_SOCKET="unix:///var/run/containerd/containerd.sock"
    echo "[+] containerd detected, using $CRI_SOCKET"
else
    echo "[-] No CRI detected! Exiting."
    exit 1
fi

echo "[2/5] é‡ç½® kubeadm..."
sudo kubeadm reset -f --cri-socket=$CRI_SOCKET --ignore-preflight-errors=Swap

echo "[3/5] æ¸…ç†æ—§è¯ä¹¦å’Œé…ç½®..."
sudo rm -rf /etc/kubernetes/pki
sudo rm -rf /etc/kubernetes/*.conf
sudo rm -rf ~/.kube

echo "[4/5] åˆ é™¤æ—§çš„ etcd æ•°æ®å’Œ kubelet çŠ¶æ€..."
sudo rm -rf /var/lib/etcd
sudo rm -rf /var/lib/kubelet/*

echo "[5/5] æ£€æŸ¥ç«¯å£ 6443 å ç”¨..."
if lsof -i :6443 >/dev/null; then
    echo "[-] Port 6443 is still in use! Please kill the process occupying it before proceeding."
    lsof -i :6443
    exit 1
fi

echo "ç¯å¢ƒæ¸…ç†å®Œæˆï¼ŒCRI socket: $CRI_SOCKET"
```

æ‰§è¡Œè„šæœ¬ï¼š

```bash
bash prepare_env.sh
```

---

## 6. åˆå§‹åŒ– Master èŠ‚ç‚¹

æ–‡ä»¶ï¼š`init_k8s.sh`

```sh
#!/bin/bash
set -e

# è¯·æ ¹æ® prepare_env.sh è¾“å‡ºå¡«å…¥ CRI socket
CRI_SOCKET="unix:///var/run/cri-dockerd.sock"

echo "[1/1] åˆå§‹åŒ– Kubernetes master..."
sudo kubeadm init \
  --kubernetes-version=1.28.15 \
  --apiserver-advertise-address=10.0.0.5 \
  --image-repository=kubernetes-registry.moon.com/google_containers \
  --pod-network-cidr="10.244.0.0/16" \
  --service-cidr="10.96.0.0/12" \
  --ignore-preflight-errors=Swap \
  --cri-socket=$CRI_SOCKET

echo "------------------------------------------------"
echo "åˆå§‹åŒ–å®Œæˆï¼"
```

æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬ï¼š

```bash
bash init_k8s.sh
```

åˆå§‹åŒ–æˆåŠŸåï¼Œæ ¹æ® `kubeadm init` çš„è¾“å‡ºï¼Œå¤åˆ¶ `kubeadm join` å‘½ä»¤åˆ°å„ä¸ª `node` èŠ‚ç‚¹è¿è¡Œã€‚

---

## 7. é…ç½® kubectl

åœ¨ master èŠ‚ç‚¹æ‰§è¡Œï¼š

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

éªŒè¯ï¼š

```bash
kubectl get nodes
```

---

## 8. å®‰è£…ç½‘ç»œæ’ä»¶ Flannel

å®‰è£… Flannel ç½‘ç»œæ’ä»¶ï¼Œä¿è¯ Pod ä¹‹é—´å¯ä»¥äº’é€šï¼š

```bash
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
```

---

## 9. éªŒè¯é›†ç¾¤çŠ¶æ€

```bash
kubectl get nodes
```

ç¤ºä¾‹è¾“å‡ºï¼š

```bash
NAME                STATUS   ROLES           AGE   VERSION
kubernetes-master   Ready    control-plane   47h   v1.28.15
kubernetes-node1    Ready    <none>          26h   v1.28.15
kubernetes-node2    Ready    <none>          26h   v1.28.15
```

è‡³æ­¤ï¼ŒKubernetes é›†ç¾¤å®‰è£…å®Œæˆ ğŸ‰

---

## 10. å¸¸è§é—®é¢˜æ’æŸ¥

1. **swap æœªå…³é—­**

   * Kubernetes è¦æ±‚ç¦ç”¨ swapï¼š

     ```bash
     sudo swapoff -a
     sed -i '/ swap / s/^/#/' /etc/fstab
     ```

2. **é•œåƒæ‹‰å–å¤±è´¥**

   * é…ç½®å›½å†…é•œåƒä»“åº“ï¼ˆå¦‚é˜¿é‡Œäº‘ã€ä¸ƒç‰›ã€è…¾è®¯äº‘ï¼‰ï¼Œæˆ–ä½¿ç”¨è‡ªå»º `kubernetes-registry`ã€‚

3. **6443 ç«¯å£è¢«å ç”¨**

   * æ£€æŸ¥å¹¶é‡Šæ”¾ç«¯å£ï¼š

     ```bash
     lsof -i :6443
     kill -9 <PID>
     ```

4. **flannel ç½‘ç»œä¸é€š**

   * ç¡®è®¤ `--pod-network-cidr` ä¸ flannel é…ç½®ä¸€è‡´ï¼ˆé»˜è®¤ `10.244.0.0/16`ï¼‰ã€‚
   * æ£€æŸ¥ CNI æ’ä»¶ç›®å½• `/etc/cni/net.d/` æ˜¯å¦å­˜åœ¨é…ç½®æ–‡ä»¶ã€‚

