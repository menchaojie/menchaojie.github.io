---
layout: post
title: Kubernetes
categories:
  - k8s
description: å­¦ä¸€äº›k8sçŸ¥è¯†
keywords:  
  - linux
  - k8s
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---



# Kubernetes é›†ç¾¤æ­å»ºç¬”è®°ï¼ˆUbuntu 24.04 + kubeadm + Docker + cri-dockerd + Flannelï¼‰

æœ¬æ–‡è®°å½•äº†åœ¨ windows è™šæ‹ŸæœºVMwareä¸­å®‰è£… **Ubuntu 24.04** ï¼Œä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤çš„è¿‡ç¨‹ï¼Œç‰ˆæœ¬ä¸º **v1.28.15**ï¼Œä½¿ç”¨ **Docker** ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ **cri-dockerd** é€‚é…ï¼Œç½‘ç»œæ’ä»¶é€‰ç”¨ **Flannel**ã€‚  

---

## 1. ä¸»æœºè§„åˆ’

- `kubernetes-master`ï¼šæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼ˆmasterï¼‰  
- `kubernetes-node1`ã€`kubernetes-node2`ï¼šå·¥ä½œèŠ‚ç‚¹ï¼ˆnodeï¼‰  
- `kubernetes-registry`ï¼šç§æœ‰é•œåƒä»“åº“  

å„ä¸»æœºå‘½åè®¾ç½®å¯ä»¥å‚è€ƒï¼š[hostnameå‘½ä»¤](https://www.runoob.com/linux/linux-comm-hostname.html) æˆ–è€… [linuxå¸¸ç”¨å‘½ä»¤](https://menchaojie.github.io/2026/01/20/linux-commands/)

---

## 2. å®‰è£… Docker

ä½¿ç”¨é˜¿é‡Œäº‘æºå®‰è£… Docker CEï¼š  
[é˜¿é‡Œäº‘ Docker å®‰è£…æ–‡æ¡£](https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.57e31b11dCQH1l)

éªŒè¯å®‰è£…ï¼š  

```bash
docker version
systemctl enable docker --now
```
ä¸ºäº†æ–¹ä¾¿æ™®é€šç”¨æˆ·ä½¿ç”¨ï¼Œå¯ä»¥å°†å½“å‰ç”¨æˆ·åŠ å…¥dockerç»„ä¸­
```bash
sudo usermod -aG docker $USER
newgrp docker
```

---

## 3. å®‰è£… cri-dockerd

Kubernetes ä» 1.24 èµ·ä¸å†ç›´æ¥æ”¯æŒ Dockerï¼Œéœ€è¦ `cri-dockerd` ä½œä¸ºé€‚é…å±‚ã€‚

å‚è€ƒæ–‡æ¡£ï¼š[å®˜æ–¹æ–‡æ¡£](https://mirantis.github.io/cri-dockerd/usage/install/)ä»¥åŠ
[cri-dockerd å®‰è£…](https://www.cnblogs.com/wangguishe/p/17825991.html)

å®‰è£…å®Œæˆåï¼Œç¡®è®¤ socket æ–‡ä»¶è·¯å¾„ï¼š

* Dockerï¼š`/var/run/cri-dockerd.sock`
* containerdï¼š`/var/run/containerd/containerd.sock`

---

## 4. å®‰è£… Kubernetes ç»„ä»¶

éœ€è¦å®‰è£…ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š

* `kubelet`ï¼šèŠ‚ç‚¹ä»£ç†ï¼Œè´Ÿè´£å¯åŠ¨å’Œç®¡ç† Pod
* `kubeadm`ï¼šé›†ç¾¤åˆå§‹åŒ–å·¥å…·
* `kubectl`ï¼šå‘½ä»¤è¡Œå®¢æˆ·ç«¯

ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/Release.key |sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
```

å…¶ä¸­çš„ç‰ˆæœ¬å·â€œv1.28â€, å¯ä»¥æ ¹æ®é˜¿é‡Œäº‘é•œåƒè¿›è¡Œæ›´æ”¹ã€‚

å‚è€ƒé˜¿é‡Œäº‘é•œåƒæºï¼š
[é˜¿é‡Œäº‘ Kubernetes é•œåƒ](https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.73281b11Uyt6jP)

å¦‚æœéœ€è¦é‡è£…æˆ–æ›´æ¢ä¸åŒç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬å¸è½½
```bash
#!/bin/bash

set -e

echo "===> [1/7] åœæ­¢ kubeletï¼ˆå¦‚æœå­˜åœ¨ï¼‰"
systemctl stop kubelet 2>/dev/null || true

echo "===> [2/7] å¸è½½ Kubernetes ç»„ä»¶ï¼ˆkubeadm / kubelet / kubectlï¼‰"
apt-get purge -y kubeadm kubelet kubectl || true

echo "===> [3/7] æ¸…ç† Kubernetes æ ¸å¿ƒç›®å½•"
rm -rf /etc/kubernetes
rm -rf /var/lib/kubelet
rm -rf /var/lib/etcd

echo "===> [4/7] æ¸…ç† CNI ç½‘ç»œæ®‹ç•™ï¼ˆå¦‚æœè£…è¿‡ç½‘ç»œæ’ä»¶ï¼‰"
rm -rf /etc/cni
rm -rf /opt/cni
rm -rf /var/lib/cni

echo "===> [5/7] æ¸…ç† kubeconfigï¼ˆé¿å… kubectl å¹»è§‰ï¼‰"
rm -rf ~/.kube

echo "===> [6/7] ç§»é™¤ Kubernetes apt æºï¼ˆå¦‚æœå­˜åœ¨ï¼‰"
rm -f /etc/apt/sources.list.d/kubernetes.list

echo "===> [7/7] åˆ·æ–° apt çŠ¶æ€"
apt-get update

echo
echo "âœ… Kubernetes å·²å½»åº•å¸è½½å®Œæˆ"
echo "ğŸ‘‰ è¿™å°æœºå™¨ç°åœ¨ä¸å†æ˜¯ Kubernetes èŠ‚ç‚¹"
echo "ğŸ‘‰ å¯ä»¥æ”¾å¿ƒé‡æ–°å®‰è£…ä»»æ„ç‰ˆæœ¬"

```
---


## 5. åˆå§‹åŒ– Master èŠ‚ç‚¹

ä¸ºé¿å…é•œåƒæ‹‰å–æ˜¯å‡ºç°é—®é¢˜ï¼Œä½¿ç”¨kubeadmåˆå§‹åŒ–ä¹‹å‰å…ˆè¦å‡†å¤‡å¥½dockeré•œåƒï¼Œæœ¬æ¬¡è®°å½•ä¸­é€šè¿‡
```bash
kubeadm config images list
```
è·å–é•œåƒåˆ—è¡¨ï¼Œç„¶åä»é˜¿é‡Œäº‘è·å–é•œåƒå­˜å…¥æœ¬åœ°harborçš„æ–¹æ³•ï¼Œè§å¦‚ä¸‹çš„å‘½ä»¤


```bash
#!/bin/bash
#
# åŒæ­¥ Kubernetes æ ¸å¿ƒé•œåƒåˆ°ç§æœ‰é•œåƒä»“åº“
# è¯´æ˜ï¼š
#   1. ä»é˜¿é‡Œäº‘ registry æ‹‰å–é•œåƒï¼ˆè§£å†³å›½å¤– registry æ‹‰å–æ…¢çš„é—®é¢˜ï¼‰
#   2. é‡æ–°æ‰“ tag åˆ°ç§æœ‰é•œåƒä»“åº“ (æ¯”å¦‚é˜¿é‡Œäº‘é•œåƒ)

#-----------------------------
# åŸºæœ¬å˜é‡é…ç½®
#-----------------------------
K8S_VERSION="1.35.0"                                     # æŒ‡å®š Kubernetes ç‰ˆæœ¬
SRC_REGISTRY="registry.aliyuncs.com/google_containers"    # æºé•œåƒä»“åº“ï¼ˆé˜¿é‡Œäº‘å…¬å…±é•œåƒï¼‰
DST_REGISTRY="crpi-ckw9ia686aku4y4w.cn-shanghai.personal.cr.aliyuncs.com/tgtech" #ç›®æ ‡ç§æœ‰ä»“åº“ï¼ˆé˜¿é‡Œäº‘ç§æœ‰é•œåƒï¼‰

#-----------------------------
# Step 1: è·å–è¯¥ç‰ˆæœ¬æ‰€éœ€é•œåƒåˆ—è¡¨
#-----------------------------
# kubeadm config images listä¼šåˆ—å‡ºéƒ¨ç½²è¯¥ç‰ˆæœ¬ Kubernetes æ‰€éœ€çš„æ‰€æœ‰é•œåƒ,å¹¶æå–æœ€åä¸€ä¸ªå­—æ®µ
#-----------------------------
echo "[INFO] è·å– Kubernetes $K8S_VERSION é•œåƒåˆ—è¡¨..."
images=$(kubeadm config images list --kubernetes-version="${K8S_VERSION}" | awk -F'/' '{print $NF}')

#-----------------------------
# Step 2: å¾ªç¯åŒæ­¥æ¯ä¸ªé•œåƒ
#-----------------------------
for image in ${images}; do
    echo
    echo "==============================="
    echo "[INFO] æ­£åœ¨å¤„ç†é•œåƒ: ${image}"
    echo "==============================="

    # æ‹‰å–é•œåƒï¼ˆä»é˜¿é‡Œäº‘æºï¼‰
    echo "[STEP] æ‹‰å– ${SRC_REGISTRY}/${image}"
    docker pull ${SRC_REGISTRY}/${image}

    # æ‰“ä¸Šç§æœ‰ä»“åº“æ ‡ç­¾
    echo "[STEP] é‡æ–°æ‰“æ ‡ç­¾ä¸º ${DST_REGISTRY}/${image}"
    docker tag ${SRC_REGISTRY}/${image} ${DST_REGISTRY}/${image}

    # æ¨é€åˆ°ç§æœ‰ Harbor ä»“åº“
    echo "[STEP] æ¨é€åˆ° Harborï¼š${DST_REGISTRY}/${image}"
    docker push ${DST_REGISTRY}/${image}

    # åˆ é™¤ä¸­è½¬é•œåƒï¼Œåªä¿ç•™ç›®æ ‡é•œåƒ
    echo "[STEP] åˆ é™¤æœ¬åœ°ä¸­è½¬é•œåƒ ${SRC_REGISTRY}/${image}"
    docker rmi ${SRC_REGISTRY}/${image}

    echo "[DONE] é•œåƒ ${image} å·²åŒæ­¥è‡³ç§æœ‰é•œåƒä»“åº“ã€‚"
done

#-----------------------------
# Step 3: å®Œæˆæç¤º
#-----------------------------
echo
echo "=========================================="
echo "[SUCCESS] æ‰€æœ‰ Kubernetes ${K8S_VERSION} æ ¸å¿ƒé•œåƒå·²åŒæ­¥å®Œæˆã€‚"
echo "å¯åœ¨ ç§æœ‰é•œåƒä»“åº“ ä¸ŠæŸ¥çœ‹ï¼š${DST_REGISTRY}"
echo "=========================================="
```

ä¸Šè¿°é•œåƒä»“åº“åœ¨åŒæ­¥å®Œæˆä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ï¼Œä½¿ç”¨ä¹‹å‰ï¼Œè¦å…ˆè¿›è¡Œç™»å½•ï¼Œå…·ä½“æ–¹æ³•è¦å‚è€ƒï¼š[é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡](https://cr.console.aliyun.com/cn-shanghai/instance/dashboard)
###  åˆå§‹åŒ–ä¹‹å‰çš„æ£€æŸ¥

å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è„šæœ¬`init_k8s_preflight.sh`è¿›è¡Œæ£€æŸ¥

```bash
#!/bin/bash
set -o pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

fail_count=0

ok()   { echo -e "${GREEN}[ OK ]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
fail() { echo -e "${RED}[FAIL]${NC} $1"; fail_count=$((fail_count+1)); }

echo "===== Kubernetes init å‰ç¯å¢ƒæ£€æŸ¥ï¼ˆDocker + cri-dockerdï¼‰====="

# --------------------------------------------------
# 1. æ“ä½œç³»ç»Ÿ
# --------------------------------------------------
if [[ -f /etc/os-release ]]; then
  source /etc/os-release
  ok "æ“ä½œç³»ç»Ÿ: $PRETTY_NAME"
else
  fail "æ— æ³•è¯†åˆ«æ“ä½œç³»ç»Ÿ"
fi

# --------------------------------------------------
# 2. å†…æ ¸ç‰ˆæœ¬
# --------------------------------------------------
ok "å†…æ ¸ç‰ˆæœ¬: $(uname -r)"

# --------------------------------------------------
# 3. Swap
# --------------------------------------------------
if swapon --summary | grep -q .; then
  warn "Swap å·²å¼€å¯ï¼ˆkubeadm é»˜è®¤ä¸æ¨èï¼Œéœ€ --ignore-preflight-errors=Swapï¼‰"
else
  ok "Swap å·²å…³é—­"
fi

# --------------------------------------------------
# 4. br_netfilter
# --------------------------------------------------
if [[ -e /sys/module/br_netfilter ]]; then
  ok "br_netfilter æ¨¡å—å·²åŠ è½½"
else
  fail "br_netfilter æ¨¡å—æœªåŠ è½½"
fi


# --------------------------------------------------
# 5. sysctl å‚æ•°
# --------------------------------------------------
check_sysctl() {
  local key=$1
  local expect=$2
  local value
  value=$(sysctl -n "$key" 2>/dev/null)
  if [[ "$value" == "$expect" ]]; then
    ok "$key = $value"
  else
    fail "$key = $valueï¼ˆæœŸæœ› $expectï¼‰"
  fi
}

check_sysctl net.bridge.bridge-nf-call-iptables 1
check_sysctl net.ipv4.ip_forward 1

# --------------------------------------------------
# 6. Docker
# --------------------------------------------------
if systemctl is-active --quiet docker; then
  ok "Docker æ­£åœ¨è¿è¡Œ"
else
  fail "Docker æœªè¿è¡Œ"
fi

# --------------------------------------------------
# 7. CRIï¼ˆå¼ºåˆ¶ cri-dockerdï¼‰
# --------------------------------------------------
CRI_SOCKET="/var/run/cri-dockerd.sock"

if ! systemctl is-active --quiet cri-docker; then
  fail "cri-dockerd æœªè¿è¡Œ"
elif ! command -v crictl &>/dev/null; then
  fail "crictl æœªå®‰è£…ï¼Œæ— æ³•éªŒè¯ CRI"
elif ! crictl --runtime-endpoint "unix://$CRI_SOCKET" info >/dev/null 2>&1; then
  fail "cri-dockerd CRI API ä¸å¯ç”¨"
else
  ok "CRI å¯ç”¨ï¼šcri-dockerd"
fi

if [[ -S "$CRI_SOCKET" ]]; then
  ok "CRI socket å­˜åœ¨: $CRI_SOCKET"
else
  fail "CRI socket ä¸å­˜åœ¨: $CRI_SOCKET"
fi

# --------------------------------------------------
# 8. Kubernetes ç»„ä»¶
# --------------------------------------------------
for bin in kubeadm kubelet kubectl; do
  if command -v $bin &>/dev/null; then
    ok "$bin å·²å®‰è£…"
  else
    fail "$bin æœªå®‰è£…"
  fi
done

# --------------------------------------------------
# 9. å…³é”®ç«¯å£
# --------------------------------------------------
check_port() {
  local port=$1
  if ss -lnt | awk '{print $4}' | grep -q ":$port$"; then
    fail "ç«¯å£ $port å·²è¢«å ç”¨"
  else
    ok "ç«¯å£ $port å¯ç”¨"
  fi
}

check_port 6443
check_port 10250

# --------------------------------------------------
# 10. Kubernetes é•œåƒæ‹‰å–éªŒè¯ï¼ˆè‡´å‘½ï¼‰
# --------------------------------------------------
IMAGE_REPO="crpi-ckw9ia686aku4y4w.cn-shanghai.personal.cr.aliyuncs.com/tgtech"
K8S_VERSION="v1.35.0"
TEST_IMAGE="$IMAGE_REPO/kube-apiserver:$K8S_VERSION"

echo "[INFO] æµ‹è¯• Docker é•œåƒæ‹‰å–ï¼š$TEST_IMAGE"

if docker pull "$TEST_IMAGE" >/dev/null 2>&1; then
  ok "Kubernetes é•œåƒå¯æ­£å¸¸æ‹‰å–"
else
  fail "Docker æ— æ³•æ‹‰å– Kubernetes é•œåƒ"
  warn "è¯·ç¡®è®¤ï¼š"
  warn "1) docker login ç§æœ‰ä»“åº“å·²å®Œæˆ"
  warn "2) é•œåƒ tag ä¸ Kubernetes ç‰ˆæœ¬ä¸€è‡´"
  warn "3) ç½‘ç»œ / DNS / é˜²ç«å¢™"
fi
# --------------------------------------------------
# 11. pause é•œåƒç‰ˆæœ¬æ£€æŸ¥ï¼ˆDocker + cri-dockerdï¼‰
# --------------------------------------------------
echo "[INFO]===== æ£€æŸ¥ CRI pause é•œåƒç‰ˆæœ¬ ====="

EXPECTED_PAUSE_IMAGE="crpi-ckw9ia686aku4y4w.cn-shanghai.personal.cr.aliyuncs.com/tgtech/pause:3.10.1"
CRI_SOCKET="/var/run/cri-dockerd.sock"

if ! command -v crictl &>/dev/null; then
  fail "crictl æœªå®‰è£…ï¼Œæ— æ³•æ£€æŸ¥ pause é•œåƒ"
else
  ACTUAL_PAUSE_IMAGE=$(crictl --runtime-endpoint "unix://${CRI_SOCKET}" info 2>/dev/null \
    | awk -F'"' '/sandboxImage/ {print $4}')

  if [[ -z "$ACTUAL_PAUSE_IMAGE" ]]; then
    fail "æ— æ³•è·å–å½“å‰ pause é•œåƒ"
  elif [[ "$ACTUAL_PAUSE_IMAGE" == "$EXPECTED_PAUSE_IMAGE" ]]; then
    ok "pause é•œåƒæ­£ç¡®ï¼š$ACTUAL_PAUSE_IMAGE"
  else
    fail "pause é•œåƒä¸åŒ¹é…"
    warn "å½“å‰: $ACTUAL_PAUSE_IMAGE"
    warn "æœŸæœ›: $EXPECTED_PAUSE_IMAGE"
    warn "è¯·å…ˆæ‰§è¡Œ sudo ./fix_cri_pause_version.sh"
  fi
fi

# --------------------------------------------------
# æ€»ç»“
# --------------------------------------------------
echo "-----------------------------------"
if [[ $fail_count -eq 0 ]]; then
  echo -e "${GREEN}ç¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼šå¯ä»¥æ‰§è¡Œ kubeadm init${NC}"
  echo -e "${GREEN}CRI socket: unix://$CRI_SOCKET${NC}"
else
  echo -e "${RED}ç¯å¢ƒæ£€æŸ¥å¤±è´¥ï¼š$fail_count é¡¹æœªé€šè¿‡ï¼Œè¯·ä¿®å¤åå†åˆå§‹åŒ–${NC}"
fi
```

### å¸¸è§é—®é¢˜è§£å†³

ä¸‹é¢å®¹æ˜“æ£€æµ‹ä¸é€šè¿‡
```bash
[ OK ] Swap å·²å…³é—­
[ OK ] br_netfilter æ¨¡å—å·²åŠ è½½
[ OK ] net.bridge.bridge-nf-call-iptables = 1
[ OK ] net.ipv4.ip_forward = 1
```

ä¸»è¦æ˜¯swapå’Œç½‘è·¯æ¨¡å—é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹è„šæœ¬è¿›è¡Œä¿®æ”¹ï¼š

1. å…³é—­swap, fix_swap.sh

```bash
#!/bin/bash
set -e

echo "===== å…³é—­ Swapï¼ˆKubernetes è¦æ±‚ï¼‰ ====="

#1. å…³é—­å½“å‰ swap
if swapon --summary | grep -q .; then
  echo "[INFO] æ£€æµ‹åˆ° Swap å·²å¼€å¯ï¼Œæ­£åœ¨å…³é—­..."
  sudo swapoff -a
else
  echo "[OK] Swap å½“å‰å·²å…³é—­"
fi

#2. æ³¨é‡Š /etc/fstab ä¸­çš„ swap
if grep -E '^\s*[^#].*\s+swap\s' /etc/fstab >/dev/null; then
  echo "[INFO] æ­£åœ¨ç¦ç”¨ /etc/fstab ä¸­çš„ Swap é…ç½®..."
  sudo sed -i.bak '/\sswap\s/s/^/#/' /etc/fstab
  echo "[OK] Swap å·²ä» /etc/fstab ä¸­ç¦ç”¨ï¼ˆå·²å¤‡ä»½ä¸º /etc/fstab.bakï¼‰"
else
  echo "[OK] /etc/fstab ä¸­æœªå‘ç°å¯ç”¨çš„ Swap"
fi

#3. éªŒè¯
if swapon --summary | grep -q .; then
  echo "[FAIL] Swap ä»ç„¶å¼€å¯"
  exit 1
else
  echo "[SUCCESS] Swap å·²å®Œå…¨å…³é—­"
fi
```

2. ä¿®æ”¹ç½‘ç»œæ¨¡å—é…ç½®, fix_k8s_net.sh

```bash
#!/bin/bash
set -e

echo "===== ä¿®å¤ Kubernetes ç½‘ç»œå†…æ ¸æ¡ä»¶ ====="

# 1. åŠ è½½ br_netfilter æ¨¡å—ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
if lsmod | grep -q br_netfilter; then
  echo "[OK] br_netfilter æ¨¡å—å·²åŠ è½½"
else
  echo "[INFO] åŠ è½½ br_netfilter æ¨¡å—..."
  sudo modprobe br_netfilter
  echo "[OK] br_netfilter æ¨¡å—å·²åŠ è½½"
fi

# 2. è®¾ç½® sysctl å‚æ•°ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
echo "[INFO] è®¾ç½® sysctl å‚æ•°..."
sudo sysctl -w net.bridge.bridge-nf-call-iptables=1
sudo sysctl -w net.ipv4.ip_forward=1

# 3. å†™å…¥æ°¸ä¹…é…ç½®ï¼ˆå¼€æœºè‡ªåŠ¨ç”Ÿæ•ˆï¼‰
echo "[INFO] å†™å…¥æ°¸ä¹…é…ç½®..."

sudo tee /etc/modules-load.d/k8s.conf >/dev/null <<EOF
br_netfilter
EOF

sudo tee /etc/sysctl.d/k8s.conf >/dev/null <<EOF
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

# 4. é‡æ–°åŠ è½½ sysctl
sudo sysctl --system >/dev/null

# 5. éªŒè¯
echo "----- éªŒè¯ç»“æœ -----"
lsmod | grep br_netfilter
sysctl net.bridge.bridge-nf-call-iptables
sysctl net.ipv4.ip_forward

echo "[SUCCESS] Kubernetes ç½‘ç»œå†…æ ¸æ¡ä»¶å·²ä¿®å¤"
```

3. ä¿®æ”¹pauseé•œåƒï¼Œ fix_cri_pause_version.sh 

```bash
#!/bin/bash
set -euo pipefail

echo "===== Fix cri-dockerd pause image ====="

#------------------------------
#å¯é…ç½®å‚æ•°
#------------------------------
PAUSE_IMAGE="crpi-ckw9ia686aku4y4w.cn-shanghai.personal.cr.aliyuncs.com/tgtech/pause:3.10.1"
SERVICE_NAME="cri-docker.service"
DROPIN_DIR="/etc/systemd/system/${SERVICE_NAME}.d"
CONF_FILE="${DROPIN_DIR}/10-pause.conf"

#------------------------------
#æ£€æµ‹ cri-dockerd binary
#------------------------------
CRI_BIN="$(command -v cri-dockerd || true)"
if [[ -z "$CRI_BIN" ]]; then
  echo "[FAIL] æœªæ‰¾åˆ° cri-dockerd å¯æ‰§è¡Œæ–‡ä»¶"
  exit 1
fi
echo "[INFO] cri-dockerd binary: $CRI_BIN"

#------------------------------
#æ£€æµ‹ systemd serviceï¼ˆæ­£ç¡®æ–¹å¼ï¼‰
#------------------------------
if ! systemctl cat "$SERVICE_NAME" >/dev/null 2>&1; then
  echo "[FAIL] systemd æœªè¯†åˆ« ${SERVICE_NAME}"
  exit 1
fi

#------------------------------
#æœŸæœ›çš„ drop-in å†…å®¹ï¼ˆå”¯ä¸€çœŸå€¼ï¼‰
#------------------------------
EXPECTED_CONF=$(cat <<EOF
[Service]
ExecStart=
ExecStart=$CRI_BIN \\
  --container-runtime-endpoint fd:// \\
  --pod-infra-container-image=${PAUSE_IMAGE}
EOF
)

#------------------------------
#å¹‚ç­‰åˆ¤æ–­
#------------------------------
if [[ -f "$CONF_FILE" ]]; then
  if diff -u <(sed '/^[[:space:]]*$/d' "$CONF_FILE") \
            <(sed '/^[[:space:]]*$/d' <<<"$EXPECTED_CONF") \
            >/dev/null; then
    echo "[OK] pause image å·²æ­£ç¡®é…ç½®ï¼Œæ— éœ€ä¿®æ”¹"
    exit 0
  else
    echo "[INFO] å‘ç°æ—§é…ç½®ï¼Œå°†æ›´æ–° pause image"
  fi
else
  echo "[INFO] æœªå‘ç° pause é…ç½®ï¼Œå°†åˆ›å»º"
fi

#------------------------------
#å†™å…¥ drop-in
#------------------------------
mkdir -p "$DROPIN_DIR"
cat > "$CONF_FILE" <<EOF
$EXPECTED_CONF
EOF

echo "[INFO] å†™å…¥ $CONF_FILE"

#------------------------------
#é‡è½½å¹¶é‡å¯
#------------------------------
systemctl daemon-reload
systemctl restart "$SERVICE_NAME"

echo "[OK] cri-dockerd pause image ä¿®å¤å®Œæˆ"

```

### åˆå§‹åŒ–è„šæœ¬

ä¹‹åå°±å¯ä»¥åˆå§‹åŒ–äº†ï¼Œè§å¦‚ä¸‹è„šæœ¬
1. å‘½ä»¤å¼çš„æ–¹æ³•
æ–‡ä»¶ï¼š`init_k8s.sh`

```bash
#!/bin/bash
set -e

# è¯·æ ¹æ® prepare_env.sh è¾“å‡ºå¡«å…¥ CRI socket
CRI_SOCKET="unix:///var/run/cri-dockerd.sock"

echo "[1/1] åˆå§‹åŒ– Kubernetes master..."
sudo kubeadm init \
  --kubernetes-version=1.28.15 \
  --apiserver-advertise-address=10.0.0.5 \
  --image-repository=kubernetes-registry.moon.com/google_containers \
  --pod-network-cidr="10.244.0.0/16" \
  --service-cidr="10.96.0.0/12" \
  --ignore-preflight-errors=Swap \
  --cri-socket=$CRI_SOCKET

echo "------------------------------------------------"
echo "åˆå§‹åŒ–å®Œæˆï¼"
```

æ³¨æ„è¦å°†å…¶ä¸­çš„ç‰ˆæœ¬(ä¸Šä¾‹å­ä¸­çš„1.28.15)è¿›è¡Œæ›¿æ¢ï¼Œæ‰§è¡Œåˆå§‹åŒ–è„šæœ¬ï¼š

```bash
bash init_k8s.sh
```

2. å£°æ˜å¼æ–¹æ³•

å‡†å¤‡yamlæ–‡ä»¶kubeadm-init.yml, 

```yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 192.168.1.20
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/cri-dockerd.sock
  name: co50-ubuntu

---
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: v1.35.0
imageRepository: crpi-ckw9ia686aku4y4w.cn-shanghai.personal.cr.aliyuncs.com/tgtech
networking:
  podSubnet: 10.244.0.0/16
  serviceSubnet: 10.96.0.0/12

```

ç„¶åæ‰§è¡Œå‘½ä»¤ï¼š

```bash
sudo kubeadm init --config kubeadm-init.yml
```

åˆå§‹åŒ–æˆåŠŸåï¼Œæ ¹æ® `kubeadm init` çš„è¾“å‡ºï¼Œå¤åˆ¶ `kubeadm join` å‘½ä»¤åˆ°å„ä¸ª `node` èŠ‚ç‚¹è¿è¡Œã€‚

---

## 6. å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œç¯å¢ƒæ¸…ç†åŠæ£€æµ‹ï¼Œå¹¶é‡æ–°åˆå§‹åŒ–

è¯´æ˜(ä¸è¦è½»æ˜“æ‰§è¡Œæ­¤æ­¥éª¤)ï¼š

1. åˆæ¬¡å®‰è£…æ˜¯ä¸éœ€è¦è¿›è¡Œç¯å¢ƒæ¸…ç†çš„ï¼Œå› ä¸ºæœ¬æ¥å°±å¾ˆå¹²å‡€ï¼Œå½“å®‰è£…è¿‡ç¨‹å‡ºé”™ï¼Œæˆ–è€…å¸Œæœ›é‡æ–°å®‰è£…ï¼Œæ‰éœ€è¦åœ¨åˆå§‹åŒ–å‰è¿›è¡Œç¯å¢ƒæ¸…ç†ï¼Œç›®çš„å°±æ˜¯æ¸…ç†æ‰ä»¥å¾€å®‰è£…çš„æ–‡ä»¶æ®‹ç•™ï¼Œ è¿™æ˜¯åœ¨ubuntu24.04ç‰ˆæœ¬å®éªŒçš„ç»“æœï¼Œå…¶ä»–ç³»ç»Ÿæˆ–ç‰ˆæœ¬æœªå¿…å¯è¡Œã€‚

2. è€Œä¸”ï¼Œè¿™æ˜¯ç¿»è½¦åé‡å»ºçš„æ­¥éª¤ï¼Œä¸è¦è½»æ˜“æ‰§è¡Œï¼Œé™¤éåˆå§‹åŒ–æŠ¥é”™ã€‚


æ–‡ä»¶ï¼š`prepare_env.sh`

```bash
#!/bin/bash
set -e

echo "[1/5] åœæ­¢ kubelet..."
sudo systemctl stop kubelet

# æ£€æµ‹ CRI
if [ -S /var/run/cri-dockerd.sock ]; then
    CRI_SOCKET="unix:///var/run/cri-dockerd.sock"
    echo "[+] Docker CRI detected, using $CRI_SOCKET"
elif [ -S /var/run/containerd/containerd.sock ]; then
    CRI_SOCKET="unix:///var/run/containerd/containerd.sock"
    echo "[+] containerd detected, using $CRI_SOCKET"
else
    echo "[-] No CRI detected! Exiting."
    exit 1
fi

echo "[2/5] é‡ç½® kubeadm..."
sudo kubeadm reset -f --cri-socket=$CRI_SOCKET --ignore-preflight-errors=Swap

echo "[3/5] æ¸…ç†æ—§è¯ä¹¦å’Œé…ç½®..."
sudo rm -rf /etc/kubernetes/pki
sudo rm -rf /etc/kubernetes/*.conf
sudo rm -rf ~/.kube

echo "[4/5] åˆ é™¤æ—§çš„ etcd æ•°æ®å’Œ kubelet çŠ¶æ€..."
sudo rm -rf /var/lib/etcd
sudo rm -rf /var/lib/kubelet/*

echo "[5/5] æ£€æŸ¥ç«¯å£ 6443 å ç”¨..."
if lsof -i :6443 >/dev/null; then
    echo "[-] Port 6443 is still in use! Please kill the process occupying it before proceeding."
    lsof -i :6443
    exit 1
fi

echo "ç¯å¢ƒæ¸…ç†å®Œæˆï¼ŒCRI socket: $CRI_SOCKET"
```

æ‰§è¡Œè„šæœ¬ï¼š

```bash
bash prepare_env.sh
```

---

## 7. é…ç½® kubectl

åœ¨ master èŠ‚ç‚¹æ‰§è¡Œï¼š

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

éªŒè¯ï¼š

```bash
kubectl get nodes
```

---

## 8. å®‰è£…ç½‘ç»œæ’ä»¶ Flannel

åˆå§‹åŒ–å®Œæˆåï¼Œä¼šæœ‰å¦‚ä¸‹æç¤ºï¼š

```bash
You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/
```

ä»¥å…¶ä¸­çš„flannelä¸ºä¾‹ï¼Œ å‚è€ƒ[flannel github](https://github.com/flannel-io/flannel#deploying-flannel-manually)ä¸­çš„å®‰è£…å‘½ä»¤ï¼š

```bash
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
```
ä½†æ˜¯ï¼Œå®‰è£…æ—¶ä½¿ç”¨çš„é•œåƒä¸å¥½ä¸‹è½½ï¼Œå¯ä»¥å…ˆä¸‹è½½åä¼ åˆ°ç§æœ‰ä»“åº“å¹¶å°†yamlæ–‡ä»¶ä¸­å¯¹åº”çš„imageè¿›è¡Œä¿®æ”¹ï¼Œç„¶åå¯åŠ¨ï¼Œå‘½ä»¤ä¾æ¬¡ä¸ºï¼š

```bash
#download the yaml file
wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml

#find the image
grep image: kube-flannel.yml

#download the image, and upload to private registry
docker pull xxxxx
docker tag xxxxx your.private.registry/namespae/xxxx:version
docker push your.private.registry/namespae/xxxx:version

#modify the image of kube-flannel.yml
vim kube-flannel.yml

#start the  flannel
kubectl apply -f kube-flannel.yml
```

å®‰è£…å®ŒæˆåæŸ¥çœ‹nodeçŠ¶æ€ï¼Œåº”è¯¥ä¸ºreadyçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æŸ¥çœ‹cniæ˜¯å¦å®‰è£…

```bash
#observe the node status, current-node-name 
#show like network plugin is not ready: cni config uninitialized
#means that the cni is not installed
kubectl describe node co50-ubuntu

#observe the cni bin
#if only flannel, means that the cni is not installed
ls /opt/cni/bin

#install cni, and then it will show as below:
#ls /opt/cni/bin
#bandwidth  dhcp   firewall  host-device  ipvlan   loopback  portmap  README.md  static  tuning  vrf
#bridge     dummy  flannel   host-local   LICENSE  macvlan   ptp      sbr        tap     vlan
sudo apt install -y kubernetes-cni

```

---

## 9. éªŒè¯é›†ç¾¤çŠ¶æ€

```bash
kubectl get nodes
```

ç¤ºä¾‹è¾“å‡ºï¼š

```bash
NAME                STATUS   ROLES           AGE   VERSION
kubernetes-master   Ready    control-plane   47h   v1.28.15
kubernetes-node1    Ready    <none>          26h   v1.28.15
kubernetes-node2    Ready    <none>          26h   v1.28.15
```

è‡³æ­¤ï¼ŒKubernetes é›†ç¾¤å®‰è£…å®Œæˆ ğŸ‰

---

## 10. k8så‘½ä»¤è¡¥å…¨
k8sæœ¬èº«è‡ªå¸¦è¿™äº›åŠŸèƒ½ï¼Œä½†éœ€è¦å¼€å¯
å¯ä»¥ä½¿ç”¨

```bash
kubectl completion -h
```

è¿›è¡ŒæŸ¥çœ‹ï¼Œå°†å…¶å‘½ä»¤å†™å…¥.bashrcé•¿æœŸä½¿ç”¨


```bash
echo 'source <(kubectl completion bash)' >> ~/.bashrc
echo 'source <(kubeadm completion bash)' >> ~/.bashrc
source ~/.bashrc
```

## 11. å¸¸è§é—®é¢˜æ’æŸ¥

1. **swap æœªå…³é—­**

   * Kubernetes è¦æ±‚ç¦ç”¨ swapï¼š

     ```bash
     sudo swapoff -a
     sed -i '/ swap / s/^/#/' /etc/fstab
     ```

2. **é•œåƒæ‹‰å–å¤±è´¥**

   * é…ç½®å›½å†…é•œåƒä»“åº“ï¼ˆå¦‚é˜¿é‡Œäº‘ã€ä¸ƒç‰›ã€è…¾è®¯äº‘ï¼‰ï¼Œæˆ–ä½¿ç”¨è‡ªå»º `kubernetes-registry`ã€‚

3. **6443 ç«¯å£è¢«å ç”¨**

   * æ£€æŸ¥å¹¶é‡Šæ”¾ç«¯å£ï¼š

     ```bash
     lsof -i :6443
     kill -9 <PID>
     ```

4. **flannel ç½‘ç»œä¸é€š**

   * ç¡®è®¤ `--pod-network-cidr` ä¸ flannel é…ç½®ä¸€è‡´ï¼ˆé»˜è®¤ `10.244.0.0/16`ï¼‰ã€‚
   * æ£€æŸ¥ CNI æ’ä»¶ç›®å½• `/etc/cni/net.d/` æ˜¯å¦å­˜åœ¨é…ç½®æ–‡ä»¶ã€‚

## 12. è¡¥å……ä¸€äº›é•œåƒç›¸å…³çš„å†…å®¹

- ä¸åŒæ¦‚å¿µä¹‹é—´çš„å…³ç³»å¦‚ä¸‹:

| å¯¹è±¡       | æ˜¯ä»€ä¹ˆ          | è§£å†³ä»€ä¹ˆé—®é¢˜                   | å’Œè°æœ‰å…³                     | hash çš„ç”¨é€”         |
| -------- | ------------ | ------------------------ | ------------------------ | ---------------- |
| layer    | æ–‡ä»¶ç³»ç»Ÿå˜æ›´åŒ…ï¼ˆtarï¼‰ | å†…å®¹å­˜å‚¨ä¸å¤ç”¨                  | è¢« manifest å¼•ç”¨            | å†…å®¹å»é‡ã€å®Œæ•´æ€§æ ¡éªŒ       |
| config   | è¿è¡Œé…ç½® JSON    | æ€ä¹ˆè¿è¡Œå®¹å™¨                   | è¢« manifest å¼•ç”¨            | Image IDï¼ˆè¿è¡Œèº«ä»½ï¼‰   |
| manifest | ç»„è£…æ¸…å• JSON    | å“ªäº› layer + å“ªä¸ª config æ˜¯ä¸€ç»„ | è¢« tag / manifest list å¼•ç”¨ | RepoDigestï¼ˆé•œåƒèº«ä»½ï¼‰ |